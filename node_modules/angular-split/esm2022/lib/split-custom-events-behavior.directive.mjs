import { Directive, ElementRef, inject, input, output } from '@angular/core';
import { gutterEventsEqualWithDelta, fromMouseDownEvent, fromMouseMoveEvent, fromMouseUpEvent, leaveNgZone, } from './utils';
import { delay, filter, fromEvent, map, mergeMap, of, repeat, scan, switchMap, take, takeUntil, tap, timeInterval, } from 'rxjs';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { DOCUMENT } from '@angular/common';
import * as i0 from "@angular/core";
/**
 * Emits mousedown, click, double click and keydown out of zone
 *
 * Emulates browser behavior of click and double click with new features:
 * 1. Supports touch events (tap and double tap)
 * 2. Ignores the first click in a double click with the side effect of a bit slower emission of the click event
 * 3. Allow customizing the delay after mouse down to count another mouse down as a double click
 */
export class SplitCustomEventsBehaviorDirective {
    constructor() {
        this.elementRef = inject(ElementRef);
        this.document = inject(DOCUMENT);
        this.multiClickThreshold = input.required({ alias: 'asSplitCustomMultiClickThreshold' });
        this.deltaInPx = input.required({ alias: 'asSplitCustomClickDeltaInPx' });
        this.mouseDown = output({ alias: 'asSplitCustomMouseDown' });
        this.click = output({ alias: 'asSplitCustomClick' });
        this.dblClick = output({ alias: 'asSplitCustomDblClick' });
        this.keyDown = output({ alias: 'asSplitCustomKeyDown' });
        fromEvent(this.elementRef.nativeElement, 'keydown')
            .pipe(leaveNgZone(), takeUntilDestroyed())
            .subscribe((e) => this.keyDown.emit(e));
        // We just need to know when drag start to cancel all click related interactions
        const dragStarted$ = fromMouseDownEvent(this.elementRef.nativeElement).pipe(switchMap((mouseDownEvent) => fromMouseMoveEvent(this.document).pipe(filter((e) => !gutterEventsEqualWithDelta(mouseDownEvent, e, this.deltaInPx(), this.elementRef.nativeElement)), take(1), map(() => true), takeUntil(fromMouseUpEvent(this.document)))));
        fromMouseDownEvent(this.elementRef.nativeElement)
            .pipe(tap((e) => this.mouseDown.emit(e)), 
        // Gather mousedown events intervals to identify whether it is a single double or more click
        timeInterval(), 
        // We only count a click as part of a multi click if the multiClickThreshold wasn't reached
        scan((sum, { interval }) => (interval >= this.multiClickThreshold() ? 1 : sum + 1), 0), 
        // As mouseup always comes after mousedown if the delayed mouseup has yet to come
        // but a new mousedown arrived we can discard the older mouseup as we are part of a multi click
        switchMap((numOfConsecutiveClicks) => 
        // In case of a double click we directly emit as we don't care about more than two consecutive clicks
        // so we don't have to wait compared to a single click that might be followed by another for a double.
        // In case of a mouse up that was too long after the mouse down
        // we don't have to wait as we know it won't be a multi click but a single click
        fromMouseUpEvent(this.elementRef.nativeElement).pipe(timeInterval(), take(1), numOfConsecutiveClicks === 2
            ? map(() => numOfConsecutiveClicks)
            : mergeMap(({ interval }) => interval >= this.multiClickThreshold()
                ? of(numOfConsecutiveClicks)
                : of(numOfConsecutiveClicks).pipe(delay(this.multiClickThreshold() - interval))))), 
        // Discard everything once drag started and listen again (repeat) to mouse down
        takeUntil(dragStarted$), repeat(), leaveNgZone(), takeUntilDestroyed())
            .subscribe((amount) => {
            if (amount === 1) {
                this.click.emit();
            }
            else if (amount === 2) {
                this.dblClick.emit();
            }
        });
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.8", ngImport: i0, type: SplitCustomEventsBehaviorDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    /** @nocollapse */ static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "18.2.8", type: SplitCustomEventsBehaviorDirective, isStandalone: true, selector: "[asSplitCustomEventsBehavior]", inputs: { multiClickThreshold: { classPropertyName: "multiClickThreshold", publicName: "asSplitCustomMultiClickThreshold", isSignal: true, isRequired: true, transformFunction: null }, deltaInPx: { classPropertyName: "deltaInPx", publicName: "asSplitCustomClickDeltaInPx", isSignal: true, isRequired: true, transformFunction: null } }, outputs: { mouseDown: "asSplitCustomMouseDown", click: "asSplitCustomClick", dblClick: "asSplitCustomDblClick", keyDown: "asSplitCustomKeyDown" }, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.8", ngImport: i0, type: SplitCustomEventsBehaviorDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[asSplitCustomEventsBehavior]',
                    standalone: true,
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXQtY3VzdG9tLWV2ZW50cy1iZWhhdmlvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXNwbGl0L3NyYy9saWIvc3BsaXQtY3VzdG9tLWV2ZW50cy1iZWhhdmlvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDNUUsT0FBTyxFQUNMLDBCQUEwQixFQUMxQixrQkFBa0IsRUFDbEIsa0JBQWtCLEVBQ2xCLGdCQUFnQixFQUNoQixXQUFXLEdBQ1osTUFBTSxTQUFTLENBQUE7QUFDaEIsT0FBTyxFQUNMLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUNULEdBQUcsRUFDSCxRQUFRLEVBQ1IsRUFBRSxFQUNGLE1BQU0sRUFDTixJQUFJLEVBQ0osU0FBUyxFQUNULElBQUksRUFDSixTQUFTLEVBQ1QsR0FBRyxFQUNILFlBQVksR0FDYixNQUFNLE1BQU0sQ0FBQTtBQUNiLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQy9ELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTs7QUFFMUM7Ozs7Ozs7R0FPRztBQUtILE1BQU0sT0FBTyxrQ0FBa0M7SUFXN0M7UUFWaUIsZUFBVSxHQUFHLE1BQU0sQ0FBMEIsVUFBVSxDQUFDLENBQUE7UUFDeEQsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUVuQyx3QkFBbUIsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFTLEVBQUUsS0FBSyxFQUFFLGtDQUFrQyxFQUFFLENBQUMsQ0FBQTtRQUMzRixjQUFTLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBUyxFQUFFLEtBQUssRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUE7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RUFBK0U7UUFDL0UsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUN2QixNQUFNLEVBQUUsRUFDUixXQUFXLEVBQUUsRUFDYixrQkFBa0IsRUFBRSxDQUNyQjthQUNBLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ3BCLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFBO1lBQ25CLENBQUM7aUJBQU0sSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUE7WUFDdEIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztpSUFyRVUsa0NBQWtDO3FIQUFsQyxrQ0FBa0M7OzJGQUFsQyxrQ0FBa0M7a0JBSjlDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLCtCQUErQjtvQkFDekMsVUFBVSxFQUFFLElBQUk7aUJBQ2pCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBpbmplY3QsIGlucHV0LCBvdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xuaW1wb3J0IHtcbiAgZ3V0dGVyRXZlbnRzRXF1YWxXaXRoRGVsdGEsXG4gIGZyb21Nb3VzZURvd25FdmVudCxcbiAgZnJvbU1vdXNlTW92ZUV2ZW50LFxuICBmcm9tTW91c2VVcEV2ZW50LFxuICBsZWF2ZU5nWm9uZSxcbn0gZnJvbSAnLi91dGlscydcbmltcG9ydCB7XG4gIGRlbGF5LFxuICBmaWx0ZXIsXG4gIGZyb21FdmVudCxcbiAgbWFwLFxuICBtZXJnZU1hcCxcbiAgb2YsXG4gIHJlcGVhdCxcbiAgc2NhbixcbiAgc3dpdGNoTWFwLFxuICB0YWtlLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbiAgdGltZUludGVydmFsLFxufSBmcm9tICdyeGpzJ1xuaW1wb3J0IHsgdGFrZVVudGlsRGVzdHJveWVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbidcblxuLyoqXG4gKiBFbWl0cyBtb3VzZWRvd24sIGNsaWNrLCBkb3VibGUgY2xpY2sgYW5kIGtleWRvd24gb3V0IG9mIHpvbmVcbiAqXG4gKiBFbXVsYXRlcyBicm93c2VyIGJlaGF2aW9yIG9mIGNsaWNrIGFuZCBkb3VibGUgY2xpY2sgd2l0aCBuZXcgZmVhdHVyZXM6XG4gKiAxLiBTdXBwb3J0cyB0b3VjaCBldmVudHMgKHRhcCBhbmQgZG91YmxlIHRhcClcbiAqIDIuIElnbm9yZXMgdGhlIGZpcnN0IGNsaWNrIGluIGEgZG91YmxlIGNsaWNrIHdpdGggdGhlIHNpZGUgZWZmZWN0IG9mIGEgYml0IHNsb3dlciBlbWlzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnRcbiAqIDMuIEFsbG93IGN1c3RvbWl6aW5nIHRoZSBkZWxheSBhZnRlciBtb3VzZSBkb3duIHRvIGNvdW50IGFub3RoZXIgbW91c2UgZG93biBhcyBhIGRvdWJsZSBjbGlja1xuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbYXNTcGxpdEN1c3RvbUV2ZW50c0JlaGF2aW9yXScsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG59KVxuZXhwb3J0IGNsYXNzIFNwbGl0Q3VzdG9tRXZlbnRzQmVoYXZpb3JEaXJlY3RpdmUge1xuICBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnRSZWYgPSBpbmplY3Q8RWxlbWVudFJlZjxIVE1MRWxlbWVudD4+KEVsZW1lbnRSZWYpXG4gIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQgPSBpbmplY3QoRE9DVU1FTlQpXG5cbiAgcmVhZG9ubHkgbXVsdGlDbGlja1RocmVzaG9sZCA9IGlucHV0LnJlcXVpcmVkPG51bWJlcj4oeyBhbGlhczogJ2FzU3BsaXRDdXN0b21NdWx0aUNsaWNrVGhyZXNob2xkJyB9KVxuICByZWFkb25seSBkZWx0YUluUHggPSBpbnB1dC5yZXF1aXJlZDxudW1iZXI+KHsgYWxpYXM6ICdhc1NwbGl0Q3VzdG9tQ2xpY2tEZWx0YUluUHgnIH0pXG4gIHJlYWRvbmx5IG1vdXNlRG93biA9IG91dHB1dDxNb3VzZUV2ZW50IHwgVG91Y2hFdmVudD4oeyBhbGlhczogJ2FzU3BsaXRDdXN0b21Nb3VzZURvd24nIH0pXG4gIHJlYWRvbmx5IGNsaWNrID0gb3V0cHV0KHsgYWxpYXM6ICdhc1NwbGl0Q3VzdG9tQ2xpY2snIH0pXG4gIHJlYWRvbmx5IGRibENsaWNrID0gb3V0cHV0KHsgYWxpYXM6ICdhc1NwbGl0Q3VzdG9tRGJsQ2xpY2snIH0pXG4gIHJlYWRvbmx5IGtleURvd24gPSBvdXRwdXQ8S2V5Ym9hcmRFdmVudD4oeyBhbGlhczogJ2FzU3BsaXRDdXN0b21LZXlEb3duJyB9KVxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGZyb21FdmVudDxLZXlib2FyZEV2ZW50Pih0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2tleWRvd24nKVxuICAgICAgLnBpcGUobGVhdmVOZ1pvbmUoKSwgdGFrZVVudGlsRGVzdHJveWVkKCkpXG4gICAgICAuc3Vic2NyaWJlKChlKSA9PiB0aGlzLmtleURvd24uZW1pdChlKSlcblxuICAgIC8vIFdlIGp1c3QgbmVlZCB0byBrbm93IHdoZW4gZHJhZyBzdGFydCB0byBjYW5jZWwgYWxsIGNsaWNrIHJlbGF0ZWQgaW50ZXJhY3Rpb25zXG4gICAgY29uc3QgZHJhZ1N0YXJ0ZWQkID0gZnJvbU1vdXNlRG93bkV2ZW50KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChtb3VzZURvd25FdmVudCkgPT5cbiAgICAgICAgZnJvbU1vdXNlTW92ZUV2ZW50KHRoaXMuZG9jdW1lbnQpLnBpcGUoXG4gICAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgKGUpID0+ICFndXR0ZXJFdmVudHNFcXVhbFdpdGhEZWx0YShtb3VzZURvd25FdmVudCwgZSwgdGhpcy5kZWx0YUluUHgoKSwgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpLFxuICAgICAgICAgICksXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICBtYXAoKCkgPT4gdHJ1ZSksXG4gICAgICAgICAgdGFrZVVudGlsKGZyb21Nb3VzZVVwRXZlbnQodGhpcy5kb2N1bWVudCkpLFxuICAgICAgICApLFxuICAgICAgKSxcbiAgICApXG5cbiAgICBmcm9tTW91c2VEb3duRXZlbnQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKChlKSA9PiB0aGlzLm1vdXNlRG93bi5lbWl0KGUpKSxcbiAgICAgICAgLy8gR2F0aGVyIG1vdXNlZG93biBldmVudHMgaW50ZXJ2YWxzIHRvIGlkZW50aWZ5IHdoZXRoZXIgaXQgaXMgYSBzaW5nbGUgZG91YmxlIG9yIG1vcmUgY2xpY2tcbiAgICAgICAgdGltZUludGVydmFsKCksXG4gICAgICAgIC8vIFdlIG9ubHkgY291bnQgYSBjbGljayBhcyBwYXJ0IG9mIGEgbXVsdGkgY2xpY2sgaWYgdGhlIG11bHRpQ2xpY2tUaHJlc2hvbGQgd2Fzbid0IHJlYWNoZWRcbiAgICAgICAgc2Nhbigoc3VtLCB7IGludGVydmFsIH0pID0+IChpbnRlcnZhbCA+PSB0aGlzLm11bHRpQ2xpY2tUaHJlc2hvbGQoKSA/IDEgOiBzdW0gKyAxKSwgMCksXG4gICAgICAgIC8vIEFzIG1vdXNldXAgYWx3YXlzIGNvbWVzIGFmdGVyIG1vdXNlZG93biBpZiB0aGUgZGVsYXllZCBtb3VzZXVwIGhhcyB5ZXQgdG8gY29tZVxuICAgICAgICAvLyBidXQgYSBuZXcgbW91c2Vkb3duIGFycml2ZWQgd2UgY2FuIGRpc2NhcmQgdGhlIG9sZGVyIG1vdXNldXAgYXMgd2UgYXJlIHBhcnQgb2YgYSBtdWx0aSBjbGlja1xuICAgICAgICBzd2l0Y2hNYXAoKG51bU9mQ29uc2VjdXRpdmVDbGlja3MpID0+XG4gICAgICAgICAgLy8gSW4gY2FzZSBvZiBhIGRvdWJsZSBjbGljayB3ZSBkaXJlY3RseSBlbWl0IGFzIHdlIGRvbid0IGNhcmUgYWJvdXQgbW9yZSB0aGFuIHR3byBjb25zZWN1dGl2ZSBjbGlja3NcbiAgICAgICAgICAvLyBzbyB3ZSBkb24ndCBoYXZlIHRvIHdhaXQgY29tcGFyZWQgdG8gYSBzaW5nbGUgY2xpY2sgdGhhdCBtaWdodCBiZSBmb2xsb3dlZCBieSBhbm90aGVyIGZvciBhIGRvdWJsZS5cbiAgICAgICAgICAvLyBJbiBjYXNlIG9mIGEgbW91c2UgdXAgdGhhdCB3YXMgdG9vIGxvbmcgYWZ0ZXIgdGhlIG1vdXNlIGRvd25cbiAgICAgICAgICAvLyB3ZSBkb24ndCBoYXZlIHRvIHdhaXQgYXMgd2Uga25vdyBpdCB3b24ndCBiZSBhIG11bHRpIGNsaWNrIGJ1dCBhIHNpbmdsZSBjbGlja1xuICAgICAgICAgIGZyb21Nb3VzZVVwRXZlbnQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpLnBpcGUoXG4gICAgICAgICAgICB0aW1lSW50ZXJ2YWwoKSxcbiAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICBudW1PZkNvbnNlY3V0aXZlQ2xpY2tzID09PSAyXG4gICAgICAgICAgICAgID8gbWFwKCgpID0+IG51bU9mQ29uc2VjdXRpdmVDbGlja3MpXG4gICAgICAgICAgICAgIDogbWVyZ2VNYXAoKHsgaW50ZXJ2YWwgfSkgPT5cbiAgICAgICAgICAgICAgICAgIGludGVydmFsID49IHRoaXMubXVsdGlDbGlja1RocmVzaG9sZCgpXG4gICAgICAgICAgICAgICAgICAgID8gb2YobnVtT2ZDb25zZWN1dGl2ZUNsaWNrcylcbiAgICAgICAgICAgICAgICAgICAgOiBvZihudW1PZkNvbnNlY3V0aXZlQ2xpY2tzKS5waXBlKGRlbGF5KHRoaXMubXVsdGlDbGlja1RocmVzaG9sZCgpIC0gaW50ZXJ2YWwpKSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICksXG4gICAgICAgICksXG4gICAgICAgIC8vIERpc2NhcmQgZXZlcnl0aGluZyBvbmNlIGRyYWcgc3RhcnRlZCBhbmQgbGlzdGVuIGFnYWluIChyZXBlYXQpIHRvIG1vdXNlIGRvd25cbiAgICAgICAgdGFrZVVudGlsKGRyYWdTdGFydGVkJCksXG4gICAgICAgIHJlcGVhdCgpLFxuICAgICAgICBsZWF2ZU5nWm9uZSgpLFxuICAgICAgICB0YWtlVW50aWxEZXN0cm95ZWQoKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKGFtb3VudCkgPT4ge1xuICAgICAgICBpZiAoYW1vdW50ID09PSAxKSB7XG4gICAgICAgICAgdGhpcy5jbGljay5lbWl0KClcbiAgICAgICAgfSBlbHNlIGlmIChhbW91bnQgPT09IDIpIHtcbiAgICAgICAgICB0aGlzLmRibENsaWNrLmVtaXQoKVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG59XG4iXX0=